<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dependency Web</title>
    <link href="./css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="./css/bootstrap-responsive.css" rel="stylesheet">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/knockout/2.3.0/knockout-min.js"></script>
    <script src="./knockout.mapping-latest.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="./dwcore.js" type="text/javascript"></script>
    <script src="./depweb_graph.js" type="text/javascript"></script>
    <script src="./dwui.js" type="text/javascript"></script>
    <script src="./js/bootstrap.min.js"></script>
<style>
html, body {
  width: 100%;
  height: 100%;
}
div#graph {
  width: 90%;
  height: 90%;
}
.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}
.textnode {
  stroke: #000;
  stroke-width: 0em;
}
#dw_graph {
  width: 100%;
  height: 700px;
}
#f_nodes {
  font-size: .75em;
}
#f_nodes .f_need span.f_need_remove {
  font-size: .75em;
}
</style>
<body>
<div style="display: none">
      <div><textarea id="dw_text">[
  {"name": "Home"}
  ,{"name": "Internet", "needs":["Power","Home"]}
  ,{"name": "Power", "needs": ["Home"]}
  ,{"name": "Dragon", "needs": ["Power"]}
  ,{"name": "DNS", "needs":["Internet", "Dragon"]}
  ,{"name": "Netflix", "needs":["DNS","Internet"]}
]</textarea></div><!--[{"name":"a", "needs": ["b","c","d","e"]},{"name":"b","needs":["c"]}]-->
      <div><button onclick="dwf_recreate()">Create!</button></div>
    </div>
<div class="row-fluid">
  <div class='span12'></div>
  <div class="span4">
    <div id="dw_form">
      <form id="f_nodes">
        <script type="text/html" id="dwui_nodes">
          <div class="row">
            <div class="span1"></div>
            <div class="span2">N: <span data-bind="text: node.name"></span></div>
            
            <div class="span2">
              <div data-bind="if: typeof node != 'undefiend'">
                <div data-bind="foreach: {data: node.needs.list, as: 'need'}">
                  <div class="row">
                    <div class="f_need">
                      <span data-bind="text: need"></span>
                      <span class="f_need_remove" data-bind="click: $root.self.removeNeed.bind($root.self, node)">Remove</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <input type="text" data-bind="event: { keypress: $root.self.addNeed.bind($root.self, node) }" />
              </div>
            </div>
          </div>
        </script>
        <div data-bind="template: { name: 'dwui_nodes', foreach: nodes, as: 'node' }"></div>
        <div class="row">
          <div class="span1"></div>
          <div class="span2">N: <input type="text" data-bind="event: { keypress: $root.self.addNode.bind($root.self) }" /> <input type="button" value="add" /></div>
          <div class="span2">
            <div data-binder="foreach: {data: node.needs, as: 'need'}">
              <div class="row">
                <div class="f_need">
                  <span data-binder="text: need"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div class="span7">
    <div id="dw_graph"></div>
  </div>
</div>
<script>
/*
  somewhat modified from the d3js example http://bl.ocks.org/mbostock/4062045
*/
var dwf_recreate = function() {
  //console.log($('#dw_text').val());
  try {
    var width = $('#dw_graph')[0].clientWidth*.9;
    var height = $('#dw_graph')[0].clientHeight*.9;
    try { myg.graph.stop(); } catch(e){}
    //delete myg;
    myg = null;
    $('#dw_graph *').remove();
    myg = new $depweb_graph('#dw_graph', width, height, $dwcore.fromArray(JSON.parse($('#dw_text').val())));
  } catch(e) {
    console.log(e.stack);
  }
}
var myg;
/*$(document).ready(function() {  
  $.get('./data.json', function(d) {
    var width = $('#dw_graph')[0].clientWidth*.9;
    var height = $('#dw_graph')[0].clientHeight*.9;
    var pd = $depweb.fromArray(d);
    //debugger;
    //myg = new $depweb_graph('#dw_graph', width, height, pd);
  })
})*/
</script>
<script type="text/javascript">
  var dwui;
  setTimeout(function(){
    dwui = $dwui.preloadForm($('#dw_text').val());
    dwui.refresh();
  }, 100);

  /*setTimeout(function() {
    console.log(new Date());
    (function() { var n = new $depweb.node("A night in", 1, ["Home", "Netflix", "Couch"]); myg.addData(n); })();
  }, 3000 );

  setTimeout(function() {
    console.log(new Date());
    (function() { var n = myg.data.nodesByName["A night in"]; n.needs.push("Dragon"); myg.updateData(n); })();
  }, 5000);

  setTimeout(function() {
    console.log(new Date());
    console.log("delete link ");
    (function() { var n = myg.data.nodesByName["A night in"]; n.needs = n.needs.filter(function(d){ return (d != "Dragon"); }); console.log("new n needs", n.needs); myg.updateData(n); })();
  }, 7000);*/
</script>
</body>
</html>
